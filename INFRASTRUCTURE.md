# Инфраструктура проекта GradMood

## 🏗️ Архитектура системы

### Общая схема

```
┌─────────────────────────────────────────────────────────────┐
│                      Telegram Users                          │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────────┐
│              Telegram Bot API (python-telegram-bot)          │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────────┐
│                    Application Layer                         │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │   Handlers   │  │   Services   │  │  Repository  │      │
│  │              │  │              │  │              │      │
│  │ • Start      │  │ • User       │  │ • User        │      │
│  │ • Language   │  │ • Test       │  │ • TestResult  │      │
│  │ • Test       │  │ • Statistics │  │              │      │
│  │ • Menu       │  │              │  │              │      │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘      │
│         │                 │                  │              │
│         └─────────────────┴──────────────────┘              │
│                            │                                │
└────────────────────────────┼────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────┐
│                    Data Layer (SQLAlchemy ORM)               │
│  ┌──────────────┐              ┌──────────────┐            │
│  │     User     │              │  TestResult  │            │
│  │              │◄─────────────│              │            │
│  │ • id         │  1:N         │ • id         │            │
│  │ • telegram_id│              │ • user_id    │            │
│  │ • language   │              │ • scores     │            │
│  └──────────────┘              └──────────────┘            │
└────────────────────────────┬────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────┐
│              PostgreSQL Database                             │
│  ┌──────────────┐              ┌──────────────┐            │
│  │    users      │              │ test_results │            │
│  └──────────────┘              └──────────────┘            │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                    Web Dashboard                             │
│  ┌──────────────┐              ┌──────────────┐            │
│  │  Flask API    │              │   Frontend   │            │
│  │  (REST)       │◄─────────────│  (HTML/JS)  │            │
│  │              │              │              │            │
│  │ • /api/users │              │ • Charts     │            │
│  │ • /api/stats │              │ • Tables     │            │
│  │ • /api/recent│              │ • Statistics │            │
│  └──────┬───────┘              └──────────────┘            │
│         │                                                    │
└─────────┼────────────────────────────────────────────────────┘
          │
          └───────────────────┐
                              ▼
                    (Same Data Layer)
```

---

## 📦 Технологический стек

### Backend
- **Python 3.11** — основной язык программирования
- **python-telegram-bot 20.7** — библиотека для работы с Telegram Bot API
- **Flask 3.0.0** — веб-фреймворк для REST API и дашборда
- **SQLAlchemy 2.0.23** — ORM для работы с базой данных
- **Alembic 1.12.1** — миграции базы данных
- **psycopg2-binary 2.9.9** — драйвер PostgreSQL

### Database
- **PostgreSQL 15** — реляционная база данных

### Frontend
- **HTML5/CSS3** — разметка и стилизация
- **JavaScript (Vanilla)** — клиентская логика
- **Chart.js 4.4.0** — визуализация данных

### Infrastructure
- **Docker** — контейнеризация приложения
- **Docker Compose** — оркестрация контейнеров
- **Alembic** — управление миграциями БД

---

## 🏛️ Архитектурные слои

### 1. Models Layer (Модели данных)
**Назначение:** Определение структуры данных и связей

```
app/models/
├── user.py          # Модель пользователя
└── test_result.py   # Модель результата теста
```

**Особенности:**
- SQLAlchemy ORM модели
- Автоматические timestamp'ы
- Связи один-ко-многим (User → TestResult)
- Индексы для оптимизации запросов

### 2. Repository Layer (Слой доступа к данным)
**Назначение:** Абстракция работы с базой данных

```
app/repository/
├── user_repository.py
└── test_result_repository.py
```

**Принципы:**
- Инкапсуляция SQL-запросов
- Переиспользуемые методы
- Изоляция от бизнес-логики

### 3. Services Layer (Бизнес-логика)
**Назначение:** Реализация бизнес-правил и операций

```
app/services/
├── user_service.py
├── test_service.py
└── statistics_service.py
```

**Функции:**
- Расчет баллов выгорания
- Агрегация статистики
- Управление пользователями

### 4. Handlers Layer (Обработчики)
**Назначение:** Обработка запросов от Telegram Bot API

```
app/handlers/
├── base.py              # Базовый класс
├── start_handler.py     # Команда /start
├── language_handler.py   # Выбор языка
├── test_handler.py      # Прохождение теста
└── menu_handler.py      # Меню и навигация
```

**Особенности:**
- Асинхронная обработка
- Управление состояниями диалога
- Интеграция с Services

### 5. API Layer (REST API)
**Назначение:** Предоставление данных для веб-дашборда

```
app/api/
├── app.py      # Flask приложение
└── routes.py   # API endpoints
```

**Endpoints:**
- `GET /api/users` — список пользователей
- `GET /api/statistics` — общая статистика
- `GET /api/recent-tests` — последние тесты

---

## 🔄 Потоки данных

### Поток прохождения теста

```
User → Telegram Bot API
  ↓
StartHandler → UserService → UserRepository → Database
  ↓
TestHandler → TestService → TestResultRepository → Database
  ↓
Results → User
```

### Поток получения статистики

```
Dashboard → Flask API
  ↓
StatisticsService → TestResultRepository → Database
  ↓
Aggregated Data → Dashboard
```

---

## 🗄️ Структура базы данных

### Таблица: users
| Поле | Тип | Описание |
|------|-----|----------|
| id | BIGINT | Первичный ключ |
| telegram_id | BIGINT | ID пользователя в Telegram (уникальный) |
| language | VARCHAR(2) | Язык интерфейса (en/ru) |
| created_at | TIMESTAMP | Дата создания |
| updated_at | TIMESTAMP | Дата обновления |

### Таблица: test_results
| Поле | Тип | Описание |
|------|-----|----------|
| id | BIGINT | Первичный ключ |
| user_id | BIGINT | Внешний ключ → users.id |
| personal_burnout | FLOAT | Личное выгорание (0-100) |
| study_burnout | FLOAT | Учебное выгорание (0-100) |
| total_burnout | FLOAT | Общее выгорание (0-100) |
| created_at | TIMESTAMP | Дата прохождения теста |

**Связи:**
- `users.id` → `test_results.user_id` (1:N)

---

## 🐳 Инфраструктура развертывания

### Docker Compose структура

```yaml
Services:
├── db (PostgreSQL 15)
│   ├── Volume: postgres_data
│   ├── Health Check: pg_isready
│   └── Port: 5432
│
└── gradmood (Application)
    ├── Depends on: db
    ├── Port: 5000 (Dashboard)
    └── Environment: .env
```

### Процесс развертывания

```
1. Запуск PostgreSQL контейнера
   ↓
2. Ожидание готовности БД (health check)
   ↓
3. Инициализация таблиц (init_db)
   ↓
4. Запуск Telegram бота
   ↓
5. Запуск Flask дашборда (в отдельном потоке)
```

---

## 📊 Масштабируемость

### Горизонтальное масштабирование
- **Stateless архитектура** — боты могут работать в нескольких экземплярах
- **База данных** — PostgreSQL поддерживает репликацию
- **Load Balancing** — можно добавить Nginx для балансировки

### Вертикальное масштабирование
- **Connection Pooling** — SQLAlchemy пул соединений
- **Индексы БД** — оптимизация запросов
- **Кэширование** — можно добавить Redis для статистики

---

## 🔐 Безопасность

### Реализовано
- **Переменные окружения** — секреты не в коде
- **SQL Injection защита** — через ORM
- **Изоляция контейнеров** — Docker network

### Рекомендации для production
- HTTPS для дашборда
- Аутентификация для API
- Rate limiting для бота
- Backup базы данных

---

## 📈 Метрики и мониторинг

### Доступные метрики
- Количество пользователей
- Количество пройденных тестов
- Средние показатели выгорания
- Тренды по времени

### Возможности расширения
- Логирование (структурированные логи)
- Prometheus метрики
- Health check endpoints
- Error tracking (Sentry)

---

## 🚀 Преимущества архитектуры

### 1. **Модульность**
- Четкое разделение ответственности
- Легкая замена компонентов
- Простое тестирование

### 2. **Масштабируемость**
- Горизонтальное масштабирование
- Оптимизация производительности
- Гибкая инфраструктура

### 3. **Поддерживаемость**
- Чистый код
- Документированная структура
- Стандартные паттерны

### 4. **Надежность**
- Транзакции БД
- Обработка ошибок
- Health checks

---

## 📁 Структура проекта

```
GradMood/
├── app/                      # Основное приложение
│   ├── models/              # ORM модели
│   ├── repository/          # Слой доступа к данным
│   ├── services/            # Бизнес-логика
│   ├── handlers/            # Обработчики бота
│   ├── api/                 # REST API
│   ├── config/              # Конфигурация
│   └── utils/               # Утилиты
├── migrations/              # Миграции БД (Alembic)
├── templates/               # HTML шаблоны
├── bot.py                   # Точка входа бота
├── dashboard.py             # Точка входа дашборда
├── entrypoint.py            # Docker entrypoint
├── docker-compose.yml       # Оркестрация
├── Dockerfile               # Образ приложения
└── requirements.txt         # Зависимости
```

---

## 🎯 Ключевые показатели

- **Слоев архитектуры:** 5 (Models, Repository, Services, Handlers, API)
- **Моделей данных:** 2 (User, TestResult)
- **API endpoints:** 3
- **Handlers:** 4 основных
- **Services:** 3 основных
- **Технологий:** 10+
- **Время развертывания:** < 2 минут (Docker)

---

## 🔧 Инструменты разработки

- **Версионирование БД:** Alembic
- **Контейнеризация:** Docker + Docker Compose
- **Управление зависимостями:** pip + requirements.txt
- **Конфигурация:** .env файлы
- **ORM:** SQLAlchemy 2.0

---

*Документ подготовлен для презентации проекта GradMood*
